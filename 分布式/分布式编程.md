# 深入理解分布式系统

## 第一章：认识分布式系统

### 1.1 什么是分布式系统？

1.   分布式系统是一个其组件分布在不同的、联网的计算机上，组件之间通过传递消息进行通信和协调，共同完成一个任务的系统。

2.   分布式系统具有如下特点：
     -   多进程，分布式系统中有多个进程并发运行
     -   不共享操作系统，通过网络通信传递消息来协作
     -   不共享时钟，很难只通过时间来定义两个事件的顺序

### 1.2 为什么需要分布式系统？

-   高性能：单核CPU -> 多核CPU -> 分布式系统（大量的CPU，内存和磁盘）
-   可扩展性：随着业务的扩展，用户的增长或者数据的积累，单机无法满足需求
-   高可用性：单机无法支持7*24小时不间断运行。通过分布式系统，冗余多份数据来保证数据的可用性；通过冗余服务，保证服务的可用性。
-   必要性：业务自身的要求。例如跨行转账

### 1.3 分布式系统范例

搜索引擎和比特币

### 1.4 分布式系统的挑战

1.   网络延迟问题

     -   消息丢失
     -   我们认为消息丢失了，实际上消息只是延迟到达
     -   网络重传，收到重复的消息
     -   消息以不同的顺序到达

2.   部分失效问题：部分节点正常工作，部分节点停止服务。

     难点在于部分失效是不确定的

3.   时钟问题

     -   很难确定分布式系统中事件发生的顺序

         -   在分布式系统中每台机器都有自己的时钟。各个物理设备的本地时钟时间不一致。

         -   网络的延迟

     -   使用时间服务器来同步时间
         -   无法解决网络可变延迟的问题
     -   通常做法是使用逻辑时钟

## 第二章：分布式系统模型

### 2.1 两将军问题

两将军问题强调通信的不可靠性：

**核心问题**：在不可靠的通信环境中，节点之间无法通过不可靠的信道达成一致。

**具体场景**：两将军需要通过不可靠的信使达成一致的进攻时间。由于信使可能会被俘虏或消息可能会丢失，两将军无法确保对方确实收到了消息并确认了进攻时间。

**主要挑战**：在不可靠的通信信道中，消息可能会丢失或延迟，导致无法确保消息的成功传递和确认。

### 2.2 拜占庭将军问题

强调节点自身的不可靠性：

**核心问题**：在一个分布式系统中，某些节点可能会出现任意类型的故障，包括恶意行为和发送错误信息，系统如何在这种情况下达成一致。

**具体场景**：多个将军需要在存在叛徒的情况下通过通信达成一致的进攻或撤退决策。叛徒可能会发送错误或不一致的信息，试图破坏一致性。

**主要挑战**：节点可能会出现拜占庭故障（任意故障），包括恶意行为、软件错误或硬件故障，导致其发送错误或不一致的信息

两将军问题和拜占庭将军问题的区别和联系：

**两将军问题**：

-   关注点：通信的不可靠性。
-   目标：在不可靠的通信信道中达成一致。
-   结论：在完全不可靠的信道中，不可能通过有限次通信达成一致。

**拜占庭将军问题**：

-   关注点：节点自身的不可靠性和恶意行为。
-   目标：在存在恶意或故障节点的情况下，所有正确的节点达成一致。
-   结论：需要采用拜占庭容错协议来在存在故障节点的情况下确保一致性。

### 2.3 分布式系统模型

按照系统会发生哪种故障，我们将系统划分为三种类型：

#### 2.3.1 网络链路模型

### 2.4 消息传递语义

按照消息传递和处理次数，有如下几种可能得消息传递语义：

-   最多一次：消息最多传递一次，可能丢失，但是不会重复
-   至少一次：每条消息至少发送一次，不会丢失，但是可能导致消息重复发送。
-   精确一次：消息有且仅有一次，不丢失不重复

我们关心的重点是消息被处理的次数，而不是消息被送达的次数。我们尽可能做到精确处理一次消息，忽略后续重复的消息。

## 第三章：分布式数据基础

### 3.1 分区

水平分区和垂直分区，在分布式系统中常用水平分区（又称为分片）

#### 3.1.1 水平分区算法

1.   范围分区：是指根据指定的关键字将数据集拆分为若干连续的范围，每一个范围存储到一个数据节点上。例如数据库中使用日期进行分区

     优点：

     -   实现简单
     -   对用来进行范围分区的关键字执行范围查询
     -   当使用分区键进行范围查询，范围较小且位于同一个节点时，性能较好
     -   可以容易的修改范围边界增加或者减少范围数据，能够简单有效的调整范围分区

     缺点：

     -   无法使用分区键之外的其他关键字进行范围查询
     -   当范围查询较大，且位于多个节点时，性能较差
     -   可能产生数据分布不均的问题，导致某些节点负载过高

2.   哈希分区

     优点：数据分布式随机的，相对均匀

     缺点：在不额外存储数据的情况下，无法执行范围查询；新增或者删除节点时，需要重新映射。

3.   （附加）点查询和范围查询

     -   点查询：
         -   直接通过唯一标识定位，使用索引可快速查找。
         -   常用哈希索引或者B树索引
     -   范围查询：
         -   需要扫描符合条件的记录范围，通常使用索引辅助扫描。
         -   常用B树索引或者范围索引（**索引相邻，物理存储顺序相邻**）

4.   一致性哈希

     优点：无需修改哈希函数；对于节点的增删，只需重新分配哈希环上的一部分数据

     缺点：

     -   当节点太少时，容易产生数据不均

     -   解决这个问题的方案是引入虚拟节点。

#### 3.1.2 分区的挑战

-   查询可能涉及多个节点
-   分布式事务

### 3.2 复制

1.   什么是复制？

     复制时指将同一份数据冗余存储在多个节点，节点间通过网络来同步数据，使之保持一致。

2.   复制的好处？
     -   增强数据的可用性（冗余备份）
     -   减少往返时间（副本节点尽可能离客户端近）
     -   增加吞吐量。分区增加吞吐量是指针对不同分区数据的请求，副本增加吞吐量是指针对相同分区的数据。

#### 3.2.1 单主复制

1.   单主复制，又叫主从复制或者主从同步。

2.   根据以何种方式同步数据，可以分为三种：
     -   同步复制
     -   异步复制
     -   半同步复制

3.   根据同步的内容可以分为：
     -   同步操作日志
     -   同步转发请求

4.   同步复制的特点：主节点执行完写请求后，必须等待所有的从节点都执行完毕，才可以回复客户端写入成功。
     -   优点：后续无论客户端想从哪一个副本读，都能读到刚才写入的数据。
     -   缺点：主节点必须等待所有节点完成，IO性能缓慢
5.   异步复制的特点：主节点执行完写请求后，立即将结果返回给客户端，无需等到副本节点写入完成。
     -   优点：主节点无需等待副本节点写入完成，IO性能较快
     -   缺点：可能影响副本数据的一致性和持久性。例如客户端收到写请求完成的响应后，立即去从某一个从节点读取数据，此时读写数据不一致。
6.   半同步复制的特点：介于同步复制和异步复制之间的一种复制机制。主节点只需等待至少一个节点同步写操作并返回信息即可，不需要等待所有的节点完成（一个节点同步复制，其余节点异步复制）。

7.   单主复制的优缺点：

     -   优点：

         -   简单易懂，易于实现

         -   仅在主节点上执行并发写操作，能够保证操作的顺序

         -   对于大量的读请求，可以通过增加多个从节点来提升读性能

     -   缺点：
         -   大量写请求时，性能存在瓶颈
         -   主节点挂机后，从节点提升为主节点不是即时的，可能会产生错误。

8.   分布式系统故障切换两种方法：

     -   主节点故障：

         -   手动切换：运维人员根据数据完整性选择节点执行。

         -   自动切换：如何使系统中只有一个主节点，同时在主节点出现故障的时候选择新的主节点？

     -   从节点故障

9.   redis中的复制方式

     -   在redis中，默认采用异步复制的方式。在redis主从结构中，异步复制的流程如下：
         -   主节点接收写命令
         -   主节点处理写命令后返回响应结果给客户端
         -   主节点将修改命令（同步操作日志）发送给从节点
     -   在使用读写分离模式时，从节点可能遇到如下问题：
         -   数据延迟（从节点落后主节点）因此在使用这种模式时，业务场景必须可以容忍一定程度的延时。

### 3.3 CAP定理

1.   什么是cap定理？

     对于一个分布式读写系统来说，只能满足一下三项中的两项，而不可能满足全部三项：

     -   一致性
     -   可用性
     -   分区容错性

2.   什么是PACELC定理？

     在分布式系统存在网络分区的情况下，必须在**可用性**和**一致性**之间做出选择；否则，系统在没有网络分区且正常运行的情况下，必须在**延迟性**和**一致性**之间做出选择。

PACELC定理扩展了CAP定理。PACELC定理的第一部分和CAP定理一致。PACELC定理的第二部分，强调即时在网络分区正常时，也应该考虑延时和一致性之间的关系。

### 3.4 一致性模型

1.   什么是一致性模型？

     一致性模型就是指在并发编程中，系统和开发者之间的一种约定，如果开发者遵循某种规则，那么开发者执行读写操作的结果是可以预测的。一致性模型本质上定义了写操作的顺序和可见性，即并发写操作执行的顺序是什么样，写操作的结果何时能够被别的进程看见。

#### 3.4.1 线性一致性











