# redis设计与实现笔记

## 第九章 数据库

### A 过期键删除策略

1.   如果一个键过期了，什么时候会被删除？

删除策略可以分为两种：主动删除和被动删除。

-   主动删除
    -   定时删除
    -   定期删除
-   被动删除
    -   惰性删除

2.   什么是定时删除？如何实现定时删除？

     设置键过期时间的同时，设置一个定时器。当过期时间来临时，立即执行对键的删除操作。

     定时删除对内存最友好，但是当过期数据比较多时，会大量消耗CPU时间。

3.   什么是惰性删除？如何实现惰性删除？

     程序在取出键的时候对键进行过期检查。惰性删除对CPU时间最友好，但是对内存不友好：

     -   如果一个键过期，但是会长期留在内存中

4.   什么是定期删除？如何实现

     定器删除时惰性删除和定时删除的折中：

     -   定期删除每隔一段时间执行一次删除过期键，同时限制删除操作执行的时长和频率，减少对CPU的影响
     -   确定定期删除的频率和时长是定期删除策略的关键。

5.   redis的过期删除策略是什么？

     redis同时使用惰性删除和定期删除两种策略。

     -   执行任意读写命令前检查输入键是否过期
     -   redis定时执行任务，在规定时间内**随机**检查一部分键的过期时间，并删除其中的过期键

6.   RDB对过期键的处理

     -   生成RDB文件：
         -   在生成RDB文件时，会忽略过期键
     -   载入RDB文件：
         -   主服务器载入RDB文件时，忽略过期键
         -   从服务器载入RDB文件时，文件中所有的键都被载入。然后在主从服务器同步的时候被清空。

7.   AOF对过期键的处理

     -   生成AOF文件
         -   当过期键被惰性删除或者定期删除时，程序会向AOF文件中增加一个DEL命令。

     -   AOF重写
         -   重写AOF文件的时候，忽略过期键

8.    复制模式对过期键的处理

      -   主服务器在删除一个过期键之后，会显式向所有从服务器发送del命令，通知从服务器删除过期键；从服务器接到del命令后才会删除过期键
      -   从服务器执行读命令时，遇到过期数据**不会主动删除**过期数据。

9.   在主从模式下，读写分离时，如何删除过期数据？

10.   

      

      